<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChessVision.ai - Gemini 3 Preview</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        chess: { board: '#769656', light: '#eeeed2', dark: '#111827' }
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        body { background-color: #111827; color: #e5e7eb; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        canvas { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Upload: () => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            X: () => <Icon path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Scan: () => <Icon path={<><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></>} />,
            Settings: () => <Icon path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />,
            ArrowRight: () => <Icon path={<line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" />} />,
            ArrowLeft: () => <Icon path={<line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" />} />,
        };

        // --- GEMINI API INTEGRATION ---
        const analyzeImage = async (base64, apiKey, modelId) => {
            if (!apiKey) throw new Error("API Key required");
            
            // Note: The user specifically requested gemini-3-pro-preview.
            // If that fails, consider falling back to gemini-1.5-flash manually in settings.
            const ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: "Analyze this chess diagram. Output ONLY the FEN string. If unsure of turn, assume white ('w'). Do not include markdown code blocks." },
                        { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }
                    ]
                }]
            };

            const res = await fetch(ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || "Gemini API Error");
            }

            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("No FEN found in response");
            
            // Clean up response (remove markdown if present)
            return text.replace(/```/g, '').replace(/^fen\s+/i, '').trim();
        };

        // --- CHESS BOARD COMPONENT ---
        const Board = ({ fen, onMove }) => {
            const [board, setBoard] = useState([]);
            const [selected, setSelected] = useState(null);

            useEffect(() => {
                const rows = fen.split(' ')[0].split('/');
                setBoard(rows.map(r => {
                    let row = [];
                    for (let c of r) {
                        if (/\d/.test(c)) row.push(...Array(parseInt(c)).fill(null));
                        else row.push(c);
                    }
                    return row;
                }));
            }, [fen]);

            const handleClick = (r, c) => {
                const files = 'abcdefgh';
                const sq = `${files[c]}${8-r}`;
                if (selected === sq) { setSelected(null); return; }
                if (selected) {
                    if (onMove(selected, sq)) { setSelected(null); return; }
                }
                if (board[r][c]) setSelected(sq);
            };

            const getPieceUrl = (p) => {
                if(!p) return null;
                const c = p === p.toUpperCase() ? 'w' : 'b';
                const t = p.toLowerCase();
                const map = {
                    'p': '[https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg](https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg)',
                    'r': '[https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg](https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg)',
                    'n': '[https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg](https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg)',
                    'b': '[https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg](https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg)',
                    'q': '[https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg](https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg)',
                    'k': '[https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg](https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg)'
                };
                if (c === 'b') {
                   map['p'] = "[https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg](https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg)";
                   map['r'] = "[https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg](https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg)";
                   map['n'] = "[https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg](https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg)";
                   map['b'] = "[https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg](https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg)";
                   map['q'] = "[https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg](https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg)";
                   map['k'] = "[https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg](https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg)";
                }
                return map[t];
            };

            return (
                <div className="grid grid-cols-8 border-4 border-gray-700 aspect-square w-full max-w-[400px] mx-auto bg-[#eeeed2]">
                    {board.map((row, r) => row.map((p, c) => (
                        <div key={`${r}-${c}`} onClick={() => handleClick(r, c)} 
                             className={`relative flex items-center justify-center cursor-pointer ${(r+c)%2===1 ? 'bg-[#769656]' : ''} ${selected===`${'abcdefgh'[c]}${8-r}` ? 'ring-4 ring-yellow-400 inset' : ''}`}>
                            {p && <img src={getPieceUrl(p)} className="w-[85%]" />}
                            {c===0 && <span className={`absolute top-0.5 left-0.5 text-[10px] font-bold ${(r+c)%2===1?'text-[#eeeed2]':'text-[#769656]'}`}>{8-r}</span>}
                            {r===7 && <span className={`absolute bottom-0 right-1 text-[10px] font-bold ${(r+c)%2===1?'text-[#eeeed2]':'text-[#769656]'}`}>{'abcdefgh'[c]}</span>}
                        </div>
                    )))}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [pdf, setPdf] = useState(null);
            const [pageNum, setPageNum] = useState(1);
            const [scale, setScale] = useState(1.5);
            const [mode, setMode] = useState('upload'); // upload, read, analyze
            const [sel, setSel] = useState(null); // {x,y,w,h}
            const [fen, setFen] = useState("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");
            const [evalScore, setEvalScore] = useState("...");
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_key") || "");
            const [modelId, setModelId] = useState("gemini-3-pro-preview");
            const [showSettings, setShowSettings] = useState(false);
            const [loading, setLoading] = useState(false);
            
            const canvasRef = useRef(null);
            const startRef = useRef(null);
            const gameRef = useRef(new window.Chess());
            const engineRef = useRef(null);

            // Init Stockfish
            useEffect(() => {
                const initSF = async () => {
                    const blob = await (await fetch('[https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')).blob](https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js')).blob)();
                    const worker = new Worker(URL.createObjectURL(blob));
                    engineRef.current = worker;
                    worker.onmessage = (e) => {
                        if(e.data.includes('score cp')) {
                            const sc = e.data.match(/score cp (-?\d+)/);
                            if(sc) setEvalScore((parseInt(sc[1])/100).toFixed(2));
                        } else if (e.data.includes('score mate')) {
                             setEvalScore('#' + e.data.match(/score mate (-?\d+)/)[1]);
                        }
                    };
                };
                initSF();
                return () => engineRef.current?.terminate();
            }, []);

            // Analyze on FEN change
            useEffect(() => {
                if (mode === 'analyze' && engineRef.current) {
                    engineRef.current.postMessage('uci');
                    engineRef.current.postMessage(`position fen ${fen}`);
                    engineRef.current.postMessage('go depth 15');
                }
            }, [fen, mode]);

            // PDF Rendering
            useEffect(() => {
                if (!pdf || !canvasRef.current) return;
                pdf.getPage(pageNum).then(page => {
                    const viewport = page.getViewport({ scale });
                    const cvs = canvasRef.current;
                    cvs.width = viewport.width;
                    cvs.height = viewport.height;
                    page.render({ canvasContext: cvs.getContext('2d'), viewport });
                });
            }, [pdf, pageNum, scale]);

            const handleFile = (e) => {
                const fr = new FileReader();
                fr.onload = (ev) => window.pdfjsLib.getDocument(new Uint8Array(ev.target.result)).promise.then(p => {
                    setPdf(p);
                    setMode('read');
                });
                fr.readAsArrayBuffer(e.target.files[0]);
            };

            // Selection Logic
            const handleDown = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                startRef.current = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                setSel({ x: startRef.current.x, y: startRef.current.y, w:0, h:0 });
            };
            const handleMove = (e) => {
                if (!startRef.current) return;
                const rect = canvasRef.current.getBoundingClientRect();
                const cx = e.clientX - rect.left;
                const cy = e.clientY - rect.top;
                setSel({
                    x: Math.min(startRef.current.x, cx),
                    y: Math.min(startRef.current.y, cy),
                    w: Math.abs(cx - startRef.current.x),
                    h: Math.abs(cy - startRef.current.y)
                });
            };
            const handleUp = () => startRef.current = null;

            // Capture & Send
            const capture = async () => {
                if (!sel || sel.w < 10) return;
                setLoading(true);
                try {
                    const cvs = canvasRef.current;
                    const tmp = document.createElement('canvas');
                    // We must account for CSS scaling vs Internal resolution
                    const rect = cvs.getBoundingClientRect();
                    const rX = cvs.width / rect.width;
                    const rY = cvs.height / rect.height;

                    tmp.width = sel.w * rX;
                    tmp.height = sel.h * rY;
                    tmp.getContext('2d').drawImage(cvs, sel.x*rX, sel.y*rY, sel.w*rX, sel.h*rY, 0, 0, tmp.width, tmp.height);
                    
                    const base64 = tmp.toDataURL('image/png');
                    const newFen = await analyzeImage(base64, apiKey, modelId);
                    
                    if (new window.Chess(newFen)) { // Validate FEN
                        setFen(newFen);
                        gameRef.current = new window.Chess(newFen);
                        setMode('analyze');
                    } else {
                        alert("Invalid FEN returned by AI");
                    }
                } catch (e) {
                    alert(e.message);
                }
                setLoading(false);
                setSel(null);
            };

            const onBoardMove = (from, to) => {
                const move = gameRef.current.move({ from, to, promotion: 'q' });
                if (move) setFen(gameRef.current.fen());
                return !!move;
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-gray-900 text-white">
                    {/* Header */}
                    <div className="flex justify-between items-center p-4 bg-gray-800 border-b border-gray-700">
                        <h1 className="font-bold flex items-center gap-2"><Icons.Scan /> ChessVision</h1>
                        <div className="flex gap-2">
                             <button onClick={() => setShowSettings(!showSettings)} className="p-2 hover:bg-gray-700 rounded-full text-gray-400"><Icons.Settings /></button>
                             {mode !== 'upload' && <button onClick={() => setMode('upload')} className="text-xs border px-2 py-1 rounded">Reset</button>}
                        </div>
                    </div>

                    {/* Settings Dropdown */}
                    {showSettings && (
                        <div className="absolute top-16 right-4 z-50 bg-gray-800 p-4 border border-gray-600 rounded shadow-xl w-72">
                            <label className="block text-xs mb-1">API Key</label>
                            <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem("gemini_key", e.target.value)}} className="w-full bg-gray-900 border border-gray-600 rounded p-1 text-sm mb-3"/>
                            <label className="block text-xs mb-1">Model ID</label>
                            <input type="text" value={modelId} onChange={e => setModelId(e.target.value)} className="w-full bg-gray-900 border border-gray-600 rounded p-1 text-sm"/>
                        </div>
                    )}

                    {/* Content */}
                    <div className="flex-1 relative overflow-hidden bg-gray-950 flex justify-center">
                        {mode === 'upload' && (
                            <div className="flex items-center justify-center h-full">
                                <label className="cursor-pointer bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold flex flex-col items-center">
                                    <Icons.Upload />
                                    <span className="mt-2">Upload PDF</span>
                                    <input type="file" accept=".pdf" className="hidden" onChange={handleFile} />
                                </label>
                            </div>
                        )}

                        {(mode === 'read' || mode === 'analyze') && (
                            <div className="relative w-full overflow-auto custom-scrollbar flex justify-center p-8">
                                <div className="relative shadow-2xl">
                                    <canvas 
                                        ref={canvasRef}
                                        className="cursor-crosshair bg-white"
                                        onMouseDown={handleDown}
                                        onMouseMove={handleMove}
                                        onMouseUp={handleUp}
                                    />
                                    {sel && sel.w > 0 && (
                                        <>
                                            <div style={{left:sel.x, top:sel.y, width:sel.w, height:sel.h}} className="absolute border-2 border-blue-500 bg-blue-500/20 pointer-events-none" />
                                            <button onClick={capture} disabled={loading} className="absolute bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded shadow-lg transform -translate-x-1/2" style={{left:sel.x + sel.w/2, top: sel.y + sel.h + 10}}>
                                                {loading ? "Thinking..." : "Scan Position"}
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {mode === 'analyze' && (
                            <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-40 flex items-center justify-center p-4">
                                <div className="bg-gray-800 rounded-xl overflow-hidden shadow-2xl max-w-4xl w-full flex flex-col md:flex-row">
                                    <div className="p-6 flex justify-center bg-gray-800">
                                        <Board fen={fen} onMove={onBoardMove} />
                                    </div>
                                    <div className="flex-1 p-6 bg-gray-900 border-l border-gray-700">
                                        <div className="flex justify-between mb-4">
                                            <h2 className="text-xl font-bold">Analysis</h2>
                                            <button onClick={() => setMode('read')} className="text-gray-400 hover:text-white"><Icons.X /></button>
                                        </div>
                                        <div className="mb-4">
                                            <div className="text-sm text-gray-500 uppercase">Evaluation</div>
                                            <div className={`text-4xl font-mono ${evalScore > 0 ? 'text-green-400' : 'text-red-400'}`}>{evalScore}</div>
                                        </div>
                                        <div className="mb-4">
                                            <div className="text-sm text-gray-500 uppercase">FEN</div>
                                            <input className="w-full bg-black/30 border border-gray-700 rounded p-2 text-xs font-mono text-gray-400" value={fen} readOnly />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {mode === 'read' && (
                           <div className="absolute bottom-6 flex gap-4 bg-gray-800 p-2 rounded-lg shadow-xl z-10">
                                <button onClick={() => setPageNum(Math.max(1, pageNum-1))} className="p-2 hover:bg-gray-700 rounded"><Icons.ArrowLeft/></button>
                                <span className="font-mono pt-2">Page {pageNum}</span>
                                <button onClick={() => setPageNum(pageNum+1)} className="p-2 hover:bg-gray-700 rounded"><Icons.ArrowRight/></button>
                           </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
