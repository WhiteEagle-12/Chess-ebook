<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChessVision - AI PDF Analyzer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* PDF and Selection Styles */
        .pdf-container { position: relative; overflow: hidden; display: inline-block; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .selection-box { border: 2px dashed #60a5fa; background-color: rgba(96, 165, 250, 0.2); position: absolute; pointer-events: none; }
        
        /* Chess Board Styles */
        .chess-square { width: 12.5%; height: 12.5%; float: left; display: flex; align-items: center; justify-content: center; position: relative; }
        .piece { width: 80%; height: 80%; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: grab; z-index: 10; }
        .piece:active { cursor: grabbing; }
        .white-square { background-color: #eeeed2; color: #769656; }
        .black-square { background-color: #769656; color: #eeeed2; }
    </style>

    <script>
        // PDF.js Worker setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Constants ---
        const STOCKFISH_URL = "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js";
        
        // Piece SVGs mapped for display
        const PIECE_URLS = {
            'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
            'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
            'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
            'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
            'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
            'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
            'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
            'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
            'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
            'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
            'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
            'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
        };

        // --- Components ---

        // 1. Settings Modal
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, modelId, setModelId }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 border border-gray-700">
                        <h2 className="text-xl font-bold mb-4 text-white"><i className="fas fa-cog mr-2"></i>Settings</h2>
                        
                        <div className="mb-4">
                            <label className="block text-gray-400 text-sm font-bold mb-2">Google Gemini API Key</label>
                            <input 
                                type="password" 
                                value={apiKey} 
                                onChange={(e) => setApiKey(e.target.value)}
                                className="w-full bg-gray-700 text-white border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-blue-500"
                                placeholder="AIzaSy..."
                            />
                            <p className="text-xs text-gray-500 mt-1">Key is stored locally in your browser.</p>
                        </div>

                        <div className="mb-6">
                            <label className="block text-gray-400 text-sm font-bold mb-2">Model ID</label>
                            <input 
                                type="text" 
                                value={modelId} 
                                onChange={(e) => setModelId(e.target.value)}
                                className="w-full bg-gray-700 text-white border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-blue-500"
                            />
                        </div>

                        <div className="flex justify-end gap-2">
                            <button 
                                onClick={onClose}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
                            >
                                Save & Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Interactive Chess Board
        const ChessBoard = ({ fen, setFen, onMove, engineEval }) => {
            const [game, setGame] = useState(new Chess(fen));
            const [selectedSquare, setSelectedSquare] = useState(null);
            
            // Sync internal game state when FEN prop changes externally
            useEffect(() => {
                try {
                    const newGame = new Chess(fen);
                    setGame(newGame);
                } catch (e) {
                    // Ignore invalid FENs temporarily while typing
                }
            }, [fen]);

            const handleSquareClick = (square) => {
                if (selectedSquare === square) {
                    setSelectedSquare(null);
                    return;
                }

                if (selectedSquare) {
                    const move = game.move({
                        from: selectedSquare,
                        to: square,
                        promotion: 'q' 
                    });

                    if (move) {
                        setFen(game.fen());
                        setSelectedSquare(null);
                        if (onMove) onMove(game.fen());
                    } else {
                        const piece = game.get(square);
                        if (piece && piece.color === game.turn()) {
                            setSelectedSquare(square);
                        } else {
                            setSelectedSquare(null);
                        }
                    }
                } else {
                    const piece = game.get(square);
                    if (piece && piece.color === game.turn()) {
                        setSelectedSquare(square);
                    }
                }
            };

            const board = [];
            const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
            const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
            
            for (let r = 0; r < 8; r++) {
                for (let f = 0; f < 8; f++) {
                    const square = files[f] + ranks[r];
                    const isBlack = (r + f) % 2 === 1;
                    const piece = game.get(square);
                    const isSelected = selectedSquare === square;
                    const lastMove = game.history({ verbose: true }).pop();
                    const isLastMove = lastMove && (lastMove.from === square || lastMove.to === square);

                    let bgClass = isBlack ? 'black-square' : 'white-square';
                    let overlayStyle = {};
                    
                    if (isSelected) overlayStyle.backgroundColor = 'rgba(255, 255, 0, 0.5)';
                    else if (isLastMove) overlayStyle.backgroundColor = 'rgba(155, 199, 0, 0.41)';

                    board.push(
                        <div key={square} className={`${bgClass} chess-square`} onClick={() => handleSquareClick(square)}>
                            <div className="absolute inset-0" style={overlayStyle}></div>
                            {piece && (
                                <div 
                                    className="piece" 
                                    style={{ backgroundImage: `url(${PIECE_URLS[piece.type === 'p' && piece.color === 'w' ? 'P' : piece.type === 'p' && piece.color === 'b' ? 'p' : piece.color === 'w' ? piece.type.toUpperCase() : piece.type]})` }}
                                ></div>
                            )}
                            {f === 0 && <span className={`absolute top-0 left-1 text-xs font-bold ${isBlack ? 'text-[#eeeed2]' : 'text-[#769656]'}`}>{ranks[r]}</span>}
                            {r === 7 && <span className={`absolute bottom-0 right-1 text-xs font-bold ${isBlack ? 'text-[#eeeed2]' : 'text-[#769656]'}`}>{files[f]}</span>}
                        </div>
                    );
                }
            }

            return (
                <div className="flex flex-col items-center w-full max-w-[500px]">
                    <div className="w-full bg-gray-800 rounded p-2 mb-2 flex justify-between items-center border border-gray-700">
                        <span className="text-gray-400 font-mono text-sm">Evaluation:</span>
                        <span className={`font-mono font-bold ${engineEval.startsWith('+') || engineEval.includes('Mate') ? 'text-green-400' : 'text-red-400'}`}>
                            {engineEval || "Calculating..."}
                        </span>
                    </div>
                    <div className="w-full aspect-square border-4 border-gray-700 shadow-2xl">
                        {board}
                    </div>
                    <div className="w-full mt-4">
                        <label className="text-xs text-gray-500 uppercase font-bold tracking-wider">FEN String</label>
                        <input 
                            className="w-full bg-gray-800 border border-gray-600 text-gray-300 text-xs font-mono p-2 rounded mt-1 focus:border-blue-500 outline-none"
                            value={fen}
                            onChange={(e) => {
                                setFen(e.target.value); 
                                if(onMove) onMove(e.target.value);
                            }}
                        />
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            // State
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [modelId, setModelId] = useState(localStorage.getItem('gemini_model_id') || 'gemini-1.5-flash');
            const [showSettings, setShowSettings] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMsg, setLoadingMsg] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            // PDF
            const [pdfDoc, setPdfDoc] = useState(null);
            const [pageNum, setPageNum] = useState(1);
            const canvasRef = useRef(null);
            const containerRef = useRef(null);

            // Selection
            const [isSelecting, setIsSelecting] = useState(false);
            const [selectionStart, setSelectionStart] = useState({ x: 0, y: 0 });
            const [selectionBox, setSelectionBox] = useState(null);

            // Analysis
            const [fen, setFen] = useState('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');
            const [engineEval, setEngineEval] = useState('0.0');
            const stockfishWorker = useRef(null);

            // --- Effects ---

            useEffect(() => {
                if (apiKey) localStorage.setItem('gemini_api_key', apiKey);
                if (modelId) localStorage.setItem('gemini_model_id', modelId);
            }, [apiKey, modelId]);

            // Init Stockfish Blob Worker
            useEffect(() => {
                fetch(STOCKFISH_URL)
                    .then(r => r.text())
                    .then(scriptContent => {
                        const blob = new Blob([scriptContent], { type: 'application/javascript' });
                        const workerUrl = URL.createObjectURL(blob);
                        stockfishWorker.current = new Worker(workerUrl);
                        
                        stockfishWorker.current.onmessage = (e) => {
                            const line = e.data;
                            if (line.startsWith('info') && line.includes('score')) {
                                const parts = line.split(' ');
                                const scoreIdx = parts.indexOf('score');
                                if (scoreIdx !== -1) {
                                    const type = parts[scoreIdx + 1]; // cp or mate
                                    const val = parseInt(parts[scoreIdx + 2]);
                                    if (type === 'cp') setEngineEval((val / 100).toFixed(2));
                                    else if (type === 'mate') setEngineEval(`#M${val}`);
                                }
                            }
                        };
                        
                        stockfishWorker.current.postMessage('uci');
                        stockfishWorker.current.postMessage('isready');
                    });
                return () => { if (stockfishWorker.current) stockfishWorker.current.terminate(); };
            }, []);

            // Trigger Engine on FEN change
            useEffect(() => {
                if (stockfishWorker.current) {
                    stockfishWorker.current.postMessage('stop');
                    stockfishWorker.current.postMessage(`position fen ${fen}`);
                    stockfishWorker.current.postMessage('go depth 15');
                }
            }, [fen]);

            // Render PDF Page
            useEffect(() => {
                if (!pdfDoc || !canvasRef.current) return;
                
                const renderPage = async () => {
                    try {
                        const page = await pdfDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 1.5 }); // High res
                        
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                    } catch (err) {
                        setErrorMsg("Error rendering page.");
                    }
                };
                renderPage();
            }, [pdfDoc, pageNum]);

            // --- Handlers ---

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const typedarray = new Uint8Array(ev.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            setPdfDoc(pdf);
                            setPageNum(1);
                            setErrorMsg('');
                        } catch (err) {
                            setErrorMsg("Invalid PDF file.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };

            // Selection Math
            const getRelativeCoords = (e) => {
                const rect = containerRef.current.getBoundingClientRect();
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            };

            const handleMouseDown = (e) => {
                if (!pdfDoc) return;
                setIsSelecting(true);
                const coords = getRelativeCoords(e);
                setSelectionStart(coords);
                setSelectionBox(null);
            };

            const handleMouseMove = (e) => {
                if (!isSelecting) return;
                const coords = getRelativeCoords(e);
                
                const x = Math.min(selectionStart.x, coords.x);
                const y = Math.min(selectionStart.y, coords.y);
                const w = Math.abs(coords.x - selectionStart.x);
                const h = Math.abs(coords.y - selectionStart.y);
                
                setSelectionBox({ x, y, w, h });
            };

            const handleMouseUp = () => setIsSelecting(false);

            const scanSelection = async () => {
                if (!selectionBox || !canvasRef.current) return;
                if (!apiKey) { setShowSettings(true); return; }

                setIsLoading(true);
                setLoadingMsg("AI Analyzing Position...");

                try {
                    // Crop logic: Map CSS display coordinates to Canvas internal resolution
                    const canvas = canvasRef.current;
                    const rect = containerRef.current.getBoundingClientRect(); // visible size
                    
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;

                    const cropX = selectionBox.x * scaleX;
                    const cropY = selectionBox.y * scaleY;
                    const cropW = selectionBox.w * scaleX;
                    const cropH = selectionBox.h * scaleY;

                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = cropW;
                    tempCanvas.height = cropH;
                    const ctx = tempCanvas.getContext('2d');
                    
                    ctx.drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
                    
                    const base64Image = tempCanvas.toDataURL('image/jpeg').split(',')[1];

                    // Gemini Call
                    const payload = {
                        contents: [{
                            parts: [
                                { text: "Analyze this chess diagram. Return ONLY the FEN string. If unsure of the turn, assume 'w'. Do not include markdown." },
                                { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                            ]
                        }]
                    };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    let resultText = data.candidates[0].content.parts[0].text.replace(/`/g, '').replace(/\n/g, '').trim();
                    
                    if (resultText.split('/').length === 8) {
                         setFen(resultText);
                    } else {
                        setErrorMsg("AI returned invalid FEN.");
                    }

                } catch (err) {
                    setErrorMsg("Scan failed: " + err.message);
                } finally {
                    setIsLoading(false);
                    setSelectionBox(null);
                }
            };

            return (
                <div className="flex flex-col h-full">
                    <header className="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-chess-knight text-blue-500 text-2xl"></i>
                            <h1 className="text-xl font-bold tracking-tight">Chess<span className="text-blue-500">Vision</span></h1>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="text-gray-400 hover:text-white transition">
                            <i className="fas fa-cog text-xl"></i>
                        </button>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* PDF View */}
                        <div className="flex-1 bg-gray-900 p-4 flex flex-col items-center overflow-auto border-r border-gray-800 relative select-none" onMouseUp={handleMouseUp}>
                            <div className="w-full max-w-3xl flex justify-between items-center mb-4 sticky top-0 z-20 bg-gray-900/90 backdrop-blur py-2">
                                <label className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded cursor-pointer text-sm font-medium transition">
                                    <i className="fas fa-upload mr-2"></i>Open PDF
                                    <input type="file" accept=".pdf" className="hidden" onChange={handleFileUpload} />
                                </label>
                                {pdfDoc && (
                                    <div className="flex items-center gap-4 bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                                        <button onClick={() => setPageNum(p => Math.max(1, p - 1))} className="text-gray-400 hover:text-white"><i className="fas fa-chevron-left"></i></button>
                                        <span className="text-sm font-mono text-gray-300">Page {pageNum} / {pdfDoc.numPages}</span>
                                        <button onClick={() => setPageNum(p => Math.min(pdfDoc.numPages, p + 1))} className="text-gray-400 hover:text-white"><i className="fas fa-chevron-right"></i></button>
                                    </div>
                                )}
                            </div>

                            {pdfDoc ? (
                                <div className="relative group">
                                    <div ref={containerRef} className="pdf-container cursor-crosshair border border-gray-700" onMouseDown={handleMouseDown} onMouseMove={handleMouseMove}>
                                        <canvas ref={canvasRef} className="block max-w-full h-auto" />
                                        {selectionBox && (
                                            <div className="selection-box flex items-end justify-end p-1" style={{ left: selectionBox.x, top: selectionBox.y, width: selectionBox.w, height: selectionBox.h }}>
                                                <button onMouseDown={(e) => e.stopPropagation()} onClick={scanSelection} className="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg hover:bg-blue-500 pointer-events-auto">SCAN</button>
                                            </div>
                                        )}
                                    </div>
                                    <p className="text-gray-500 text-sm mt-2 text-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-crop-simple mr-1"></i> Drag to select a diagram</p>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center text-gray-600">
                                    <i className="fas fa-file-pdf text-6xl mb-4"></i>
                                    <p>Upload a PDF to get started</p>
                                </div>
                            )}
                        </div>

                        {/* Analysis View */}
                        <div className="w-[400px] bg-gray-800 p-4 flex flex-col border-l border-gray-700 shrink-0 overflow-y-auto">
                            <h2 className="text-lg font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">Analysis Board</h2>
                            <ChessBoard fen={fen} setFen={setFen} onMove={(f) => setFen(f)} engineEval={engineEval} />
                            
                            <div className="mt-8 p-4 bg-gray-700/50 rounded text-sm text-gray-400">
                                <h3 className="font-bold text-gray-300 mb-2">How it works</h3>
                                <ul className="list-disc pl-4 space-y-1">
                                    <li>Open a Chess PDF.</li>
                                    <li>Drag a box over a diagram.</li>
                                    <li>Click <strong>SCAN</strong>.</li>
                                    <li>AI converts image to FEN.</li>
                                    <li>Stockfish evaluates the position.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} apiKey={apiKey} setApiKey={setApiKey} modelId={modelId} setModelId={setModelId} />

                    {isLoading && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                            <p className="text-blue-400 font-mono animate-pulse">{loadingMsg}</p>
                        </div>
                    )}

                    {errorMsg && (
                        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded shadow-lg z-50 flex items-center gap-3">
                            <i className="fas fa-exclamation-circle"></i>
                            <span>{errorMsg}</span>
                            <button onClick={() => setErrorMsg('')} className="ml-2 hover:text-gray-200"><i className="fas fa-times"></i></button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
